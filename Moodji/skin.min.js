const ScriptName="Moodji获取全皮肤 v1.0",ScriptIdentifier="moodji_patch",$=new Env(ScriptName),res=$request,resp=isUndefined($response)?null:$response,clientVersion="2.0.0.0",skinType=28;let bannedSkinList=["vip","default"];function initScript(){let t=JSON.parse(resp.body),r=t.products||[];for(let t=0;t<r.length;t++)bannedSkinList.includes(r[t].productId)||bannedSkinList.push(r[t].productId);let a=$.getdata(ScriptIdentifier+"_own_skin_id_list");if(void 0===a||""===a)a=bannedSkinList;else try{a=JSON.parse(a)}catch(t){$.setdata("",ScriptIdentifier+"_own_skin_id_list"),$.logErr(t)}let n=0,o="";getAllSkinList(res.headers,s=>{if(s.success){let e=r.length;for(let t=0;t<s.data.length;t++){var i;bannedSkinList.includes(s.data[t].skinId)||(i={id:e++,seed:"",initTime:1709220187,count:1,productId:s.data[t].skinId,type:2,expireTime:2524607999},r.push(i),a.includes(s.data[t].skinId))||(n++,o+=s.data[t].skinName+"、",a.push(s.data[t].skinId))}o=o.substring(0,o.length-1),t.products=r,$.setdata(JSON.stringify(a),ScriptIdentifier+"_own_skin_id_list"),0<n&&$.msg(`此次额外为你获取${n}个皮肤`,"",o.substring(0,o.length-1)),$.done({body:JSON.stringify(t)})}else $.done({body:JSON.stringify(resp)})})}function getAllSkinList(t,i){t={url:"https://moodji.api.flowzland.com//moodjiallinone/v1/getskinlist",headers:t,body:`{"type":${skinType},"clientVersion":"${clientVersion}"}`,timeout:2e3};$.post(t,(t,e,s)=>{s={success:!0,msg:"Success",data:JSON.parse(s)};t&&(s.success=!1,s.msg="获取皮肤列表失败",s.data=t),s.data.hasOwnProperty("skinInfoList")?s.data=s.data.skinInfoList:(s.success=!1,s.msg="获取皮肤列表失败"),s.success||$.msg("Error",s.msg,t),i(s)})}function isUndefined(t){return void 0===t}function isNull(t){return null===t}function Env(a,t){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((i,r)=>{s.call(this,t,(t,e,s)=>{t?r(t):i(e)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}isShadowrocket(){return"undefined"!=typeof $rocket}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;if(this.getdata(t))try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(i=>{this.get({url:t},(t,e,s)=>i(s))})}runScript(a,n){return new Promise(i=>{let t=this.getdata("@chavy_boxjs_userCfgs.httpapi");t=t&&t.replace(/\n/g,"").trim();var e=(e=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout"))?+e:20,[s,r]=(e=n&&n.timeout?n.timeout:e,t.split("@"));this.post({url:`http://${r}/v1/scripting/evaluate`,body:{script_text:a,mock_type:"cron",timeout:e},headers:{"X-Key":s,Accept:"*/*"}},(t,e,s)=>i(s))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};this.fs=this.fs||require("fs"),this.path=this.path||require("path");var t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}writedata(){var t,e,s,i,r;this.isNode()&&(this.fs=this.fs||require("fs"),this.path=this.path||require("path"),t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),i=!(s=this.fs.existsSync(t))&&this.fs.existsSync(e),r=JSON.stringify(this.data),!s&&i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r))}lodash_get(t,e,s){let i=t;for(const t of e.replace(/\[(\d+)\]/g,".$1").split("."))if(i=Object(i)[t],void 0===i)return s;return i}lodash_set(t,i,e){return Object(t)!==t||((i=Array.isArray(i)?i:i.toString().match(/[^.[\]]+/g)||[]).slice(0,-1).reduce((t,e,s)=>Object(t[e])===t[e]?t[e]:t[e]=Math.abs(i[s+1])>>0==+i[s+1]?[]:{},t)[i[i.length-1]]=e),t}getdata(t){let e=this.getval(t);if(/^@/.test(t)){var[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),s=s?this.getval(s):"";if(s)try{const t=JSON.parse(s);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){var[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),a=this.getval(i),a=i?"null"===a?null:a||"{}":"{}";try{const e=JSON.parse(a);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){a={};this.lodash_set(a,r,t),s=this.setval(JSON.stringify(a),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got||require("got"),this.cktough=this.cktough||require("tough-cookie"),this.ckjar=this.ckjar||new this.cktough.CookieJar,t&&(t.headers=t.headers||{},void 0===t.headers.Cookie)&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar)}get(t,r=()=>{}){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),r(t,e,s)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>r(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{var s;t.headers["set-cookie"]&&((s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString())&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar)}catch(t){this.logErr(t)}}).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;r(t,e,e&&e.body)}))}post(t,r=()=>{}){var e=t.method?t.method.toLocaleLowerCase():"post";if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient[e](t,(t,e,s)=>{!t&&e&&(e.body=s,e.statusCode=e.status),r(t,e,s)});else if(this.isQuanX())t.method=e,this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>r(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got[e](s,i).then(t=>{var{statusCode:t,statusCode:e,headers:s,body:i}=t;r(null,{status:t,statusCode:e,headers:s,body:i},i)},t=>{var{message:t,response:e}=t;r(t,e,e&&e.body)})}}time(t,e=null){var s,e=e?new Date(e):new Date,i={"M+":e.getMonth()+1,"d+":e.getDate(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(s in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),i)new RegExp("("+s+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[s]:("00"+i[s]).substr((""+i[s]).length)));return t}msg(t=a,e="",s="",i){var r=t=>{return t&&("string"==typeof t?this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0:"object"==typeof t?this.isLoon()?{openUrl:t.openUrl||t.url||t["open-url"],mediaUrl:t.mediaUrl||t["media-url"]}:this.isQuanX()?{"open-url":t["open-url"]||t.url||t.openUrl,"media-url":t["media-url"]||t.mediaUrl}:this.isSurge()?{url:t.url||t.openUrl||t["open-url"]}:void 0:void 0)};this.isMute||(this.isSurge()||this.isLoon()?$notification.post(t,e,s,r(i)):this.isQuanX()&&$notify(t,e,s,r(i))),this.isMuteLog||((r=["","==============📣系统通知📣=============="]).push(t),e&&r.push(e),s&&r.push(s),console.log(r.join("\n")),this.logs=this.logs.concat(r))}log(...t){0<t.length&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?this.log("",`❗️${this.name}, 错误!`,t.stack):this.log("",`❗️${this.name}, 错误!`,t)}wait(e){return new Promise(t=>setTimeout(t,e))}done(t={}){var e=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${e} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(a,t)}initScript();